<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Seguro - {{ username }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; height: 100vh; display: flex; flex-direction: column; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.5rem; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        
        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        .sidebar { width: 300px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .stats-panel { padding: 1rem; border-bottom: 1px solid #eee; }
        .stats-panel h3 { margin-bottom: 0.5rem; color: #333; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .stat-value { font-weight: bold; color: #667eea; }
        
        .users-panel { flex: 1; padding: 1rem; }
        .users-panel h3 { margin-bottom: 0.5rem; color: #333; }
        .user-list { list-style: none; }
        .user-item { padding: 0.5rem; margin-bottom: 0.25rem; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; gap: 0.5rem; }
        .user-status { width: 8px; height: 8px; background: #28a745; border-radius: 50%; }
        
        .chat-container { flex: 1; display: flex; flex-direction: column; }
        .messages-container { flex: 1; padding: 1rem; overflow-y: auto; background: #fafafa; }
        .message { margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .message-author { font-weight: bold; color: #333; }
        .message-time { font-size: 0.8rem; color: #666; }
        .message-content { color: #444; line-height: 1.4; }
        .message-footer { margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #666; }
        .verification-status { display: flex; align-items: center; gap: 0.25rem; }
        .verified { color: #28a745; }
        .not-verified { color: #dc3545; }
        
        .input-container { padding: 1rem; background: white; border-top: 1px solid #ddd; }
        .input-form { display: flex; gap: 0.5rem; }
        .message-input { flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 25px; font-size: 1rem; }
        .message-input:focus { outline: none; border-color: #667eea; }
        .send-btn { padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 25px; cursor: pointer; }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 1rem; background: #28a745; color: white; border-radius: 5px; transform: translateX(100%); transition: transform 0.3s; }
        .notification.show { transform: translateX(0); }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Chat Seguro</h1>
        <div class="user-info">
            <span>Ol√°, {{ username }}!</span>
            <a href="/logout" class="logout-btn">Sair</a>
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="stats-panel">
                <h3>üìä Estat√≠sticas</h3>
                <div class="stat-item">
                    <span>Usu√°rios Online:</span>
                    <span class="stat-value" id="active-users">0</span>
                </div>
                <div class="stat-item">
                    <span>Mensagens Enviadas:</span>
                    <span class="stat-value" id="messages-sent">0</span>
                </div>
                <div class="stat-item">
                    <span>Taxa de Verifica√ß√£o:</span>
                    <span class="stat-value" id="verification-rate">100%</span>
                </div>
            </div>
            
            <div class="users-panel">
                <h3>üë• Usu√°rios Online</h3>
                <ul class="user-list" id="user-list"></ul>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="messages-container" id="messages"></div>
            
            <div class="input-container">
                <form class="input-form" id="message-form">
                    <input type="text" class="message-input" id="message-input" placeholder="Digite sua mensagem..." required>
                    <button type="submit" class="send-btn">Enviar</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        const socket = io();
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const userList = document.getElementById('user-list');
        const activeUsers = new Set();
        
        // Conectar ao WebSocket
        socket.on('connect', function() {
            showNotification('Conectado ao chat!', 'success');
        });
        
        // Receber nova mensagem
        socket.on('new_message', function(data) {
            addMessage(data);
            scrollToBottom();
        });
        
        // Usu√°rio entrou
        socket.on('user_joined', function(data) {
            activeUsers.add(data.username);
            updateUserList();
            showNotification(`${data.name} entrou no chat`, 'info');
        });
        
        // Usu√°rio saiu
        socket.on('user_left', function(data) {
            activeUsers.delete(data.username);
            updateUserList();
        });
        
        // Atualizar estat√≠sticas
        socket.on('stats_update', function(data) {
            document.getElementById('active-users').textContent = data.active_users;
            document.getElementById('messages-sent').textContent = data.messages_sent;
            document.getElementById('verification-rate').textContent = data.verification_rate.toFixed(1) + '%';
        });
        
        // Enviar mensagem
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('send_message', { message: message });
                messageInput.value = '';
            }
        });
        
        function addMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-author">${data.name}</span>
                    <span class="message-time">${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">${data.message}</div>
                <div class="message-footer">
                    <div class="verification-status ${data.verified ? 'verified' : 'not-verified'}">
                        ${data.verified ? '‚úì Verificada' : '‚úó N√£o verificada'}
                    </div>
                    <div>Assinatura: ${data.signature_preview}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
        }
        
        function updateUserList() {
            userList.innerHTML = '';
            activeUsers.forEach(username => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.innerHTML = `
                    <div class="user-status"></div>
                    <span>${username}</span>
                `;
                userList.appendChild(li);
            });
        }
        
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Auto-focus no input
        messageInput.focus();
    </script>
</body>
</html>
